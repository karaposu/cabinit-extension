async function x(t){try{const o=await(await fetch(t)).blob();return new Promise((n,d)=>{const a=new FileReader;a.onloadend=()=>{const i=a.result.replace(/^data:.+;base64,/,"");n(i)},a.onerror=d,a.readAsDataURL(o)})}catch(e){console.error("Error converting image to Base64:",e)}}const b=t=>{window.parent.postMessage(t,"*")},y=async({targetImage:t,avatar:e})=>{var a,i,p,g,c,s;const n="https://7p53xc8ktq.eu-central-1.awsapprunner.com/MAN_DOM_IMAGE/",d={data:{source_headswapObjs:[{head_img:(a=e.images.head)==null?void 0:a.replace("data:image/webp;base64,",""),headselection_mask:(i=e.images.headselection_mask)==null?void 0:i.replace("data:image/webp;base64,",""),FD_coordinates:e.FD_coordinates,LM_coordinates:e.LM_coordinates,skincolor:e.skincolor,total_time:e.total_time},{head_img:(p=e.images.head)==null?void 0:p.replace("data:image/webp;base64,",""),headselection_mask:(g=e.images.headselection_mask)==null?void 0:g.replace("data:image/webp;base64,",""),FD_coordinates:e.FD_coordinates,LM_coordinates:e.LM_coordinates,skincolor:e.skincolor,total_time:e.total_time},{head_img:(c=e.images.head)==null?void 0:c.replace("data:image/webp;base64,",""),headselection_mask:(s=e.images.headselection_mask)==null?void 0:s.replace("data:image/webp;base64,",""),FD_coordinates:e.FD_coordinates,LM_coordinates:e.LM_coordinates,skincolor:e.skincolor,total_time:e.total_time}],target_image:t},config:{ASD:{skincolortransfer:0,headorientation:0,hairtransfer:0,generic_setting1:0,generic_setting2:0},return_img_format:"encoded"},operation:{userid:"user1234",package_sent_time:"2024-03-06T12:00:00Z",counter:1,link:"https://api.example.com/operations/1234",operation_name:"headswap"}};try{const r=document.createElement("div");r.className="spinner",r.innerHTML='<img src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" alt="Loading..." />',r.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      background-color: rgba(0, 0, 0, 0.5);
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      display: flex;
      flex-direction: column;
    `;const m=document.createElement("p");m.innerText="Processing image...",m.style.cssText=`
      color: white;
      font-size: 24px;
    `,r.appendChild(m),document.body.appendChild(r);const l=await fetch(n,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(d)});if(!l.ok)throw new Error(`HTTP error! Status: ${l.status}`);const f=await l.json(),u=JSON.parse(f.data);return r.remove(),m.remove(),{faceReplacedDomImage:`data:image/webp;base64, ${u.images[0].result}`}}catch(r){return console.error(r),spinner.remove(),console.error("Error fetching data:",r),[]}},_=async()=>{const t=async({type:e})=>await chrome.storage.local.get([e]);try{const{myHeadDrops:e}=await t({type:"myHeadDrops"}),{favoritedHeadDrops:o}=await chrome.storage.local.get(["favoritedHeadDrops"]);return new Promise((n,d)=>{let a=[];e.forEach(i=>{o.includes(i.name)&&a.push(i)}),n({favoritedHeadDrops:a})})}catch(e){throw console.error("Failed to load head drops:",e),e}},E=t=>{chrome.storage.local.get(["targetImage"],async({targetImage:e})=>{const o=await x(e.targetImage),{faceReplacedDomImage:n}=await y({targetImage:o,avatar:t.avatar}),d={action:"update-image",widgetId:"widget-for-"+encodeURIComponent(window.location.href),targetImageSelector:e.targetImageSelector,targetImage:e.targetImage,willBeUpdatedImage:n};b(d);const a=document.getElementById("my-extension-widget-container");a&&a.remove()})};(async()=>{await w();let t=!1;const e=document.createElement("div");Object.assign(e.style,{position:"fixed",top:"200px",left:"-250px",width:"170px",height:"40px",backgroundColor:"#f0f0f0",transition:"left 0.5s ease",zIndex:"9999",display:"flex",paddingInlineEnd:"15px",alignItems:"center",justifyContent:"end",borderRadius:"0px 4px 4px 0px",border:"1px solid #999",cursor:"pointer"}),e.textContent="Cabinit again!",document.body.appendChild(e);const o=document.createElement("div");Object.assign(o.style,{position:"fixed",top:"200px",left:"0",zIndex:"10000",width:"40px",height:"40px",transition:"width 0.3s ease",cursor:"pointer",backgroundImage:"url('https://pngimg.com/uploads/letter_f/letter_f_PNG78.png')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",borderRadius:"0px 4px 4px 0px",border:"1px solid #999",backgroundColor:"#fff"}),o.addEventListener("mouseover",()=>{t||(o.style.width="40px")}),o.addEventListener("mouseout",()=>{t||(o.style.width="30px")}),document.body.appendChild(o),o.addEventListener("click",()=>{t?(e.style.left="-250px",o.style.width="30px"):(e.style.left="0",o.style.width="40px"),t=!t}),e.addEventListener("click",async()=>{await w(),e.style.left="-250px",o.style.width="30px"}),document.addEventListener("click",n=>{t&&!e.contains(n.target)&&!o.contains(n.target)&&(e.style.left="-250px",o.style.width="30px",t=!1)})})();async function w(){var n,d;document.readyState==="loading"&&await new Promise(a=>document.addEventListener("DOMContentLoaded",a));const{favoritedHeadDrops:t}=await _(),e=(n=t[0])!=null&&n.previewPhotoBase64?(d=t[0])==null?void 0:d.previewPhotoBase64:"https://www.pngitem.com/pimgs/m/272-2720656_user-profile-dummy-hd-png-download.png";Array.from(document.querySelectorAll("img")).filter(a=>a.clientWidth>200&&a.clientHeight>300).forEach(a=>{const i=document.createElement("div");i.className="flex-widget-btn",Object.assign(i.style,{position:"relative",width:"40px",height:"40px",borderRadius:"100%",cursor:"pointer",position:"absolute",top:"5px",left:"5px",zIndex:"1000",padding:"10px",border:"2px solid rgb(255, 255, 255)",transition:"width 0.3s ease 0s",backgroundImage:`url(${e})`,backgroundColor:"papayawhip",backgroundSize:"cover",backgroundPosition:"center"});const p=a.parentElement;getComputedStyle(p).position==="static"&&(p.style.position="relative"),p.appendChild(i),window.addEventListener("message",s=>{if(s.data.action==="update-image"){document.querySelector(s.data.targetImageSelector).src=s.data.willBeUpdatedImage,document.querySelector(".my-extension-widget-container").remove();const r=document.querySelector('img[src="'+s.data.imageSrc+'"]');r?r.src=s.data.newImageUrl:console.warn("Main image element not found or src does not match.")}},!1);const g={content:"''",position:"absolute",top:"0",left:"0",width:"0",height:"100%",backgroundColor:"rgba(255, 255, 255, 0.4)",transition:"none"},c=document.createElement("div");Object.assign(c.style,g),i.appendChild(c),i.addEventListener("mouseover",()=>{c.style.width="120%",c.style.backgroundColor="rgba(255, 255, 255, 0)",c.style.transition="all 0.4s ease-in-out"}),i.addEventListener("mouseout",()=>{c.style.width="0",c.style.transition="none",c.style.transition="all 0.4s ease-in-out",console.log("cikti"),Object.assign(c.style,g),i.appendChild(c)}),i.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),E(t[0])}),i.addEventListener("contextmenu",s=>{s.preventDefault(),s.stopPropagation();const r=k(a);a.classList.add("flex-manipulated"),chrome.storage.local.set({targetImage:{targetImage:a.src?a.src:"",targetImageSelector:r}});const m=document.querySelector(".my-extension-widget-container");m&&m.remove();const l=document.createElement("div");Object.assign(l.style,{boxShadow:"0 0 5px 5px rgba(0, 0, 0, 0.2)",borderRadius:"5px",position:"absolute",top:"40px",left:"5px",zIndex:"2147483647",width:"170px",height:"85px",overflow:"hidden"}),l.className="my-extension-widget-container";const f=`widget-for-${a.src}`;l.setAttribute("id",f);const u=document.createElement("iframe");u.src=chrome.runtime.getURL("Widget/index.html"),Object.assign(u.style,{width:"100%",height:"100%",border:"none"}),l.appendChild(u),p.appendChild(l);const h=document.createElement("button");h.textContent="X",h.onclick=()=>l.remove(),Object.assign(h.style,{position:"absolute",top:"0",right:"0",background:"none",border:"none",cursor:"pointer",fontSize:"16px",padding:"4px"}),l.appendChild(h)})})}function k(t){if(!(t instanceof Element))return;const e=[];for(;t.nodeType===Node.ELEMENT_NODE;){let o=t.nodeName.toLowerCase();if(t.id){o+="#"+t.id,e.unshift(o);break}else{let n=t,d=1;for(;n=n.previousElementSibling;)n.nodeName.toLowerCase()==o&&d++;d!=1&&(o+=":nth-child("+d+")")}e.unshift(o),t=t.parentNode}return e.join(" > ")}
